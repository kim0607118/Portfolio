#include <SSD1306.h>
#include <MsTimer2.h>
// OLED Setup
#define OLED_DC 5
#define OLED_CLK 8
#define OLED_MOSI 7
#define OLED_RESET 6
SSD1306 oled(OLED_MOSI, OLED_CLK, OLED_DC, OLED_RESET, 0);
//MOTOR driver pin
#define PWM 9
#define IN1 10
#define IN2 11
//Encoder Pin
#define ENCODER_A 3
#define ENCODER_B 2

float t = 0;
unsigned int time_val = 0;
float Ts = 0.001;
float End_Time = 1.0;

void Set_PWM(int motor)
{
  if (motor >= 0)
  {
    digitalWrite(IN1, LOW);
    digitalWrite(IN2, HIGH);
    analogWrite(PWM, motor);
  }
  else
  {
    digitalWrite(IN1, HIGH);
    digitalWrite(IN2, LOW);
    analogWrite(PWM, motor);
  }
}



int cart_encoder = 0;
float cart_position = 0.0;
float cart_velocity = 0;
float filtered_velocity = 0;
float prev_cart_position = 0.0;
float prev_filtered_velocity = 0.0;

void control() {
  cart_position = float(cart_encoder) / 520 * PI;

  float cart_velocity = (cart_position - prev_cart_position) / Ts;
  float filtered_velocity = ((0.97560975609756097560975609756098) * prev_filtered_velocity) + ((0.02439024390243902439024390243902) * cart_velocity);

  prev_cart_position = cart_position;
  prev_filtered_velocity = filtered_velocity;


  if (t > End_Time)
    Set_PWM(0);
  else
    Set_PWM(255);

  t += Ts;
  // Serial Write
  byte * time_ = (byte *) &t;
  byte * filtered_velocity_ = (byte *) &filtered_velocity;

  Serial.write(time_, 4);
  Serial.write(filtered_velocity_, 4);

}



void setup() {
  //display setup
  int fff = 1;
  TCCR1B = (TCCR1B & 0xF8) | fff;
  oled.ssd1306_init(SSD1306_SWITCHCAPVCC);
  oled.clear();   // clears the screen and buffer

  //motor driver setup
  pinMode(IN1, OUTPUT);
  pinMode(IN2, OUTPUT);
  pinMode(PWM, OUTPUT);

  //Encoder Setup
  pinMode(ENCODER_A, INPUT);
  pinMode(ENCODER_B, INPUT);

  Serial.begin(2000000);
  delay(200);
  //Timer Setup
  MsTimer2::set(1, control);
  MsTimer2::start();
  //Interrupt Setup
  attachInterrupt(0, doEncoderA, CHANGE);
  attachInterrupt(1, doEncoderB, CHANGE);

  // motor STOP
  digitalWrite(IN1, 0);
  digitalWrite(IN2, 0);
  digitalWrite(PWM, 0);

  oled.drawstring(00, 2, "BUMP_TEST");
  oled.display();

}

void loop() {
}

void doEncoderA() {
  // Fill in the Missing Code
        if(digitalRead(ENCODER_A) == digitalRead(ENCODER_B))
      {
        cart_encoder =  cart_encoder +1;
      }
      else
      {
        cart_encoder = cart_encoder -1;
      }
}
void doEncoderB() {
  // Fill in the Missing Code
       if(digitalRead(ENCODER_A) == digitalRead(ENCODER_B))
      {
        cart_encoder =  cart_encoder -1;
      }
      else
      {
        cart_encoder = cart_encoder +1;
      }
}
